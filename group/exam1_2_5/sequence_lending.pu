@startuml 図書館システム
title 図書館 貸出処理（基本＋代替）

actor 学生
actor 職員
boundary 貸出受付画面
boundary 管理番号入力画面
control 本人確認処理
control 貸出可否判定
control 貸出登録処理
control 返却期日設定
entity 会員
entity 資料
entity 予約
entity 貸出
entity 貸出履歴
entity 在庫状態

== 基本フロー ==
学生 -> 職員: 本＋学生証/職員証を提示
職員 -> 貸出受付画面: 受付開始
貸出受付画面 -> 本人確認処理: 会員番号照合
本人確認処理 -> 会員: 照合(会員番号)
会員 --> 本人確認処理: 照合OK
本人確認処理 --> 貸出受付画面: OK

職員 -> 管理番号入力画面: 資料の管理番号をスキャン/入力
管理番号入力画面 -> 貸出可否判定: 判定リクエスト(管理番号, 会員ID)
貸出可否判定 -> 資料: 種別確認(書籍/雑誌)
貸出可否判定 -> 在庫状態: 在庫/貸出状況確認
貸出可否判定 -> 予約: 予約有無確認
貸出可否判定 -> 会員: 現在の貸出冊数確認

alt 可 (学生:<=6冊/職員:<=12冊, 学生は雑誌以外, 予約衝突なし, 未貸出)
  貸出可否判定 --> 貸出登録処理: 可
  貸出登録処理 -> 貸出: 貸出レコード作成
  貸出登録処理 -> 在庫状態: 状態=貸出中に更新
  貸出登録処理 -> 貸出履歴: 履歴追記
  貸出登録処理 -> 返却期日設定: 期日=3週間後の設定
  返却期日設定 -> 貸出: 期日更新
  返却期日設定 --> 管理番号入力画面: 完了(期日表示)
  管理番号入力画面 --> 職員: レシート/期日案内
  職員 --> 学生: 資料引渡し
else A1: 学生が雑誌を借りようとした
  貸出可否判定 --> 管理番号入力画面: 貸出不可(学生×雑誌)
  管理番号入力画面 --> 職員: 理由表示
  職員 --> 学生: 案内(別資料を提案)
else A2: 上限冊数超過(学生>6 / 職員>12)
  貸出可否判定 --> 管理番号入力画面: 貸出不可(上限超過)
  管理番号入力画面 --> 職員: 理由表示
  職員 --> 学生: 冊数調整を案内
else A3: 予約者が存在(先約優先)
  予約 --> 貸出可否判定: 予約あり(他者)
  貸出可否判定 --> 管理番号入力画面: 貸出不可(取置優先)
  管理番号入力画面 --> 職員: 理由表示
  職員 --> 学生: 予約案内/待ちの説明
else A4: 既に貸出中/在庫なし
  在庫状態 --> 貸出可否判定: 貸出中 or 在庫0
  貸出可否判定 --> 管理番号入力画面: 貸出不可(予約案内)
  管理番号入力画面 --> 職員: 理由表示
  職員 --> 学生: 予約受付を案内
else A5: 身分証不備/会員未登録/照合不一致
  会員 --> 本人確認処理: NG
  本人確認処理 --> 貸出受付画面: 受付不可
  貸出受付画面 --> 職員: 理由表示
  職員 --> 学生: 登録/再持参の依頼
end

@enduml
